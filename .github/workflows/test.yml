name: Test action

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

jobs:
  # --- Composite action approach (bunx) ---
  test-composite:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Record start time
        id: timing
        run: echo "start=$(date +%s%3N)" >> "$GITHUB_OUTPUT"

      - uses: ./
        id: dev-server

      - name: Record ready time
        id: ready
        run: echo "ready=$(date +%s%3N)" >> "$GITHUB_OUTPUT"

      - name: Verify health endpoint
        run: |
          STATUS=$(curl -sf "${{ steps.dev-server.outputs.url }}/health")
          echo "Health response: ${STATUS}"
          echo "$STATUS" | grep -q '"ok"'

      - name: Verify welcome page
        run: curl -sf "${{ steps.dev-server.outputs.url }}/" > /dev/null

      - name: Report timing
        run: |
          START=${{ steps.timing.outputs.start }}
          READY=${{ steps.ready.outputs.ready }}
          ELAPSED=$(( READY - START ))
          echo "### Composite action (bunx)" >> "$GITHUB_STEP_SUMMARY"
          echo "Time to ready: **${ELAPSED}ms**" >> "$GITHUB_STEP_SUMMARY"

  # --- Service container approach (Docker) ---
  test-service-container:
    runs-on: ubuntu-latest
    services:
      liveblocks:
        image: ghcr.io/liveblocks/cli:sha-5fb5f4b
        ports:
          - 1153:1153
    steps:
      - name: Record start time
        id: timing
        run: echo "start=$(date +%s%3N)" >> "$GITHUB_OUTPUT"

      - name: Verify health endpoint
        run: |
          STATUS=$(curl -sf http://localhost:1153/health)
          echo "Health response: ${STATUS}"
          echo "$STATUS" | grep -q '"ok"'

      - name: Verify welcome page
        run: curl -sf http://localhost:1153/ > /dev/null

      - name: Record done time
        id: done
        run: echo "done=$(date +%s%3N)" >> "$GITHUB_OUTPUT"

      - name: Report timing
        run: |
          START=${{ steps.timing.outputs.start }}
          DONE=${{ steps.done.outputs.done }}
          ELAPSED=$(( DONE - START ))
          echo "### Service container (Docker)" >> "$GITHUB_STEP_SUMMARY"
          echo "Steps time: **${ELAPSED}ms** (excludes image pull + container start in job setup)" >> "$GITHUB_STEP_SUMMARY"
          echo "Check the **Initialize containers** phase in the job log for the full startup time." >> "$GITHUB_STEP_SUMMARY"

  # --- Composite action with custom port ---
  test-custom-port:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ./
        id: dev-server
        with:
          port: 8080

      - name: Verify server on custom port
        run: |
          curl -sf http://localhost:8080/health
          echo "${{ steps.dev-server.outputs.url }}" | grep -q "8080"
